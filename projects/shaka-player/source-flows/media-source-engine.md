# Media Source Engine

## MediaSourceEngine.prototype.init

- Waits till the `MediaSource` has been created, setup and attached to the video element
- Loops through all the streams in the `streamByType` map
  - First it validates that the stream is supported
  - When the stream is of type text, uses the `TextEngine` to handle the mime type
  - Otherwise, first it checks if it needs to use the transmuxer and if the transmuxer would support this stream
    - If that is the case, it initializes a new `Transmuxer` and generates a new mime type
  - Then it creates a `sourceBuffer` adding it to the MediaSource - Example about this: https://developer.mozilla.org/en-US/docs/Web/API/MediaSource/addSourceBuffer
  - It saves and adds event listeners to the source buffer

## Media Source Engine Flush

- In case that the passed content type (only argument) is of type text, return a resolved promise
- Enqueues the operation to flush the given content type (this returns a promise)
  - Validates that the engine has not been destroyed
  - Adds the action (to flush in this case) to a queue for the given content type
  - If it is the only item in the queue, calls the action
  - Returns the public promise from the operation
- The internal flush method is called
  - It validates that the buffered length value (TimeRanges instance) for the video is 0: https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/buffered
  - Manually seeks by setting the video's `currentTime` one millisecond
  - Manually calls the `updateend` event handler
    - Validates that there is an operation in the queue for the content type
    - Validates that the source buffer for the content type is not updating
    - Removes the operation from the queue

This flow highlights a few interesting properties in the engine: `sourceBuffers_` (map from content type to source buffers) and the `queues_` (map from content type to an array / queue of operantions - async construct).

The conent types in the enum are: text, video, audio and application. Also reminds the existence of [Source Buffers](https://developer.mozilla.org/en-US/docs/Web/API/SourceBuffer), which are used and generated by the `MediaSource` (e.g. with `addSourceBuffer(MIME_TYPE)`). The source buffers contain array buffers, which can be added using `appendBuffer` passing `Uint8Array`. For a good example and presentation: https://github.com/nickdesaulniers/netfix
