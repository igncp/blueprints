# ibus-rime

- Reviewed SHA: `d525f18`
- Not many loc, around 1000 of code (including header files), all in C (no C++)
- This wiki page talks about how to use this package:
    - https://github.com/rime/home/wiki/RimeWithIBus
- The IBus project, the main dependency of this rime repo, has a wiki in Github which is mostly in English
    - There is a special guide for creating new engines: https://github.com/ibus/ibus/wiki/Develop
- Some of the commits date from 2011
- It uses several APIs from `glib` like `glib-object`

## Infra

- In `package/make-package` it uses `git archive` in order to generate a tar file
- It uses [cmake](https://linux.die.net/man/1/cmake) to setup the project build
- [x] Manage to run a local build of `ibus-rime` and see the logs from it
    - [`./scripts/run_ibus_rime.sh`](./scripts/run_ibus_rime.sh)

## Code

- The main loop function from IBus is `ibus_main`
- Many core structs come from `librime/src/rime_api.h`, for example: `RimeConfig` or `RimeTraits`

- `rime_main.c`
    - It registers a callback for `SIGTERM` and `SIGINT` signals
    - It saves the rime api (provided by `librime`) in a global pointer using the `RimeApi` struct

### Flows

- Entry Point:
    1. Register termination callbacks
    1. Set a global pointer using the `librime` api object
    1. Initialize and check status for `ibus` and `libnotify`
    1. Create the configuration options for `librime` and pass them to the api's setup function
    1. Initialize rime
    1. Run ibus main-loop function
    1. Cleanup variables

## Misc

- It has a `.gitattributes` file for ignoring some directories (git submodules) when running `git archive`
- `__declspec` is an api for windows
- The `ibus` repository is bigger than `ibus-rime` or `librime`, it has ~90k loc of C (including headers) and ~15k loc of Python
- In the `cmake` configuration there is a list of paths to extract rime data:
    - `/usr/share/rime-data` exists in my setup, however, in my previous experience it uses `~/.config/ibus/rime/` which is not listed there
- It looks like the `librime` api may be able to have more than one session at the same time. It exposes a function to find a session with a session id.
- The XML file is installed under: `/usr/share/ibus/component/rime.xml`, from the `CMakeLists.txt` and `Makefile` files

## Doubts resolved

- [x] How is the font size configuration applied in rime UI
    - The UI for configuring the font size is from IBus and not rime

- [ ] : __Move it to a flow__. What is the flow when IBus is enabled and a user types something in the keyboard
    - Seems starting in `ibus_rime_engine_process_key_event` from `rime_engine.c`
    - It is added to the engine generated by a macro from IBus repo: `IBUS_ENGINE_CLASS`
    - From `ibus-rime` the key is passed to `librime` by using `rime_api->process_key`, also passing the session id plus key modifiers like the `shift` key
        - The api delegates processing the key to the session instance
    - Also from `ibus-rime`, there is a lot of updates in `ibus_rime_engine_update`, some of them involve updating the UI in IBus
        - It updates the IBus icon and label UI by using a status struct from the `librime` api
        - It handles the current input by using the commit, which seems to mean that the user pressed enter
        - There is a variable called `inline_text` which is a `IBusText` struct, and contains the text that hasn't been commited yet

- [x] There are a few files with the `.in` extension but I don't know what is the reason
    - The `.in` doesn't seem to be a standard extension but I guess it means "input"
    - They are used inside `CMakeLists.txt` to convert them into the final files (without `.in` suffix)
    - The builtin function parsing them is [`configure_file`](https://cmake.org/cmake/help/latest/command/configure_file.html)
        - It also passes the `@ONLY` variable which means that inside those files all the variables will be of the format: `@FOO@`

- [x] How to edit the candidate options texts displayed in the GUI
    - The function giving color to the texts is [`ibus_text_append_attribute`](https://ibus.github.io/docs/ibus-1.5/IBusText.html#ibus-text-append-attribute), by choosing the index where the pronunciation starts
    - The numbers on the left are added with `ibus_lookup_table_set_label` and called `label`
    - The rest of the candidate (including the character and the pronunciation) is called `cand_text`

## Doubts

- [ ] How to change the icon used by rime
    - The `.png` image is saved in the `icons` directory and copied by `cmake` during install

- [ ] Why some functions defined in `rime_engine.c` (below `functions prototype` comment) seem not implemented or used
    - On the commit when adding these functions, they were used by referencing them into one engine, but seems they are unused now
    - Maybe for backwards compatibility?
    - Many of them are implemented and used, however found `ibus_rime_engine_cursor_down` which isn't

- [ ] Where is pressing `F4` (options to change the character type, or en to zh) handled? Where is it saved? Special handler for the 2nd row? Where are the characters from?
    - One of the key parts looks to be `librime/src/rime/lever/switcher_settings.cc` as this part is named `switcher`
        - It gets the hotkeys (e.g. `F4`) from the YAML configuration file
    - Another important class is `librime/src/rime/switcher.cc`
    - The util to change characters type (simplified, tranditional), using OpenCC, is related to the `simplifier.h`
        - This is registered by `librime/src/rime/gear/gears_module.cc` to be used by the Switcher
        - It uses the `librime` registry class, which uses the singleton pattern and only exposes one instance
        - In the `gears` module there are a few types of items registered: filters, processors, segmentors, translators, and formatters
    - The util to change between half-width and full-width characters is in: `librime/src/rime/gear/punctuator.cc`
        - The `Punctuator` main class inherits from the `Processor` class, however the `Simplifier` class inhertis the `Filter` class
        - The `Processor` class is just in a header file and doesn't have an implementation

## Links

- [Repo](https://github.com/rime/ibus-rime)
